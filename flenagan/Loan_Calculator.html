<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Javascript Loan Calculator</title>
  <style>
    .output{ font-weight: bold; }
    #payment{ text-decoration: underline;}
    #graph{ border: solid black 1px; }
    th, td{ vertical-align: top;}
  </style>
</head>
<body>
  <table>
    <tr>
      <th>Введите кредитные данные:</th>
      <td></td>
      <th>Loan Balance, Cumulative Equity, and Interest Payments</th>
    </tr>

    <tr>
      <td>Сумма кредита ($):</td>
      <td><input id='amount' onchange='calculate();'></td>
      <td rowspan=8><canvas id='graph' width='400' height='250'></canvas></td>
    </tr>

    <tr>
      <td>Годовой процент (%):</td>
      <td><input id='apr' onchange='calculate();'></td>
    </tr>

    <tr>
      <td>Срок погашения (в годах): </td>
      <td><input id='years' onchange='calculate();'></td>
    </tr>

    <tr>
      <td>Почтовый индекс (найти кредиторов):</td>
      <td><input id='zipcode' onchange='calculate()'></td>
    </tr>

    <tr>
      <td><button onclick='calculate();'>Рассчитать!</button></td>
    </tr>

    <tr>
      <td>Ежемесячный платеж:</td>
      <td>$<span class='output' id='payment'></span></td>
    </tr>

    <tr>
      <td>Всего к оплате:</td>
      <td>$<span class='output' id='total'></span></td>
    </tr>

    <tr>
      <td>Total interest:</td>
      <td>$<span class='output' id='totalinterest'></span></td>
    </tr>

    <tr>
      <th>Спонсоры:</th>
      <td colspan='2'>
        Подать заявку на кредит с одним из этих кредиторов:
        <div id="lenders"></div>
      </td>
    </tr>
  </table>

  <script>
    'use strict';

    function calculate(){
      var amount = document.getElementById('amount'),
          apr = document.getElementById('apr'),
          years = document.getElementById('years'),
          payment = document.getElementById('payment'),
          total = document.getElementById('total'),
          totalinterest = document.getElementById('totalinterest'),

          principal = parseFloat(amount.value),
          interest = parseFloat(apr.value) / 100 / 12,
          payments = parseFloat(years.value) * 12,

          x = Math.pow(1 + interest, payments),
          monthly = (principal*x*interest)/(x-1);

      if(isFinite(monthly)) {
        // Заполнить поля вывода, округлив результаты до 2 десятичных знаков
        payment.innerHTML = monthly.toFixed(2);
        total.innerHTML = (monthly * payments).toFixed(2);
        totalinterest.innerHTML = ((monthly*payments)-principal).toFixed(2);

        // Сохранить ввод пользователя, чтобы можно было восстановить данные
        // при следующем открытии страницы
        save(amount.value, apr.value, years.value);

        // Реклама: отыскать и отобразить ссылки на сайты местных кредитных
        // учреждений, но игнорировать сетевые ошибки
        try{ // Перехватывать ошибки, возникающие в этих фигурных скобках
          getLenders(amount.value, apr.value, years.value);
        }
        catch(e) { /* ...и игнорировать их */}

        // В заключение вывести график изменения остатка по кредиту,
        // а также графики сумм, выплачиваемых в погашение кредита и по процентам
        chart(principal, interest, monthly, payments);
      }
      else {
        // В этом случае результат не является числом или
        // имеет бесконечное значение.
        // Очистить все результаты, выведенные ранее.
        payment.innerHTML = '';
        total.innerHTML = '';
        totalinterest = '';
        chart();           // При вызове без аргументов очищает диаграмму
      }
    }


    // Сохранить ввод пользователя в свойствах объекта localStorage. Значение
    // этих свойств будут доступными при повторном посещении страницы.
    function save(amount, apr, years, zipcode) {
      if(window.localStorage) { // Выполнить сохранение, если поддерживается
        localStorage.loan_amount = amount;
        localStorage.loan_apr = apr;
        localStorage.loan_years = years;
      }
    }

    window.onload = function(){
      if(window.localStorage && localStorage.loan_amount) {
        document.getElementById('amount').value = localStorage.loan_amount;
        document.getElementById('apr').value = localStorage.loan_apr;
        document.getElementById('years').value = localStorage.loan_years;
      }
    };


  </script>
</body>
</html>
